<div class="prestamos-container">
  <!-- TITULO Y BOTON CREAR -->
  <div class="table-header">
    <div class="header-title">
      <h1>Préstamos</h1>
      <p class="subtitle">Gestión de préstamos de equipos de mecatrónica</p>
    </div>    <button class="botoncrear" (click)="crearprestamo()">
       Nuevo Préstamo
    </button>
  </div>

  <!-- BUSCADOR -->
  <div class="search-container">
    <div class="search-input-wrapper">
      <i class="fas fa-search search-icon"></i>
      <input 
        type="text" 
        [(ngModel)]="terminoBusqueda" 
        (keydown.enter)="buscar()"
        placeholder="Buscar préstamos..." 
        class="search-input"
      />
      @if (terminoBusqueda) {
        <button class="clear-search" (click)="limpiarBusqueda()">
          <i class="fas fa-times"></i>
        </button>
      }
    </div>
  </div>

  <!-- TABLA -->
  <div class="table-responsive">
    <table class="data-table">
      <thead>
        <tr>
          <th (click)="ordenarPor('Id')">
            ID
            @if (sortColumn === 'Id') {
              <i [class]="sortDirection === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down'"></i>
            }
          </th>
          <th (click)="ordenarPor('CarnetUsuario')">
            Carnet Usuario
            @if (sortColumn === 'CarnetUsuario') {
              <i [class]="sortDirection === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down'"></i>
            }
          </th>
          <th (click)="ordenarPor('NombreUsuario')">
            Nombre Usuario
            @if (sortColumn === 'NombreUsuario') {
              <i [class]="sortDirection === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down'"></i>
            }
          </th>
          <th (click)="ordenarPor('NombreGrupoEquipo')">
            Grupo Equipo
            @if (sortColumn === 'NombreGrupoEquipo') {
              <i [class]="sortDirection === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down'"></i>
            }
          </th>
          <th (click)="ordenarPor('CodigoImt')">
            Código IMT
            @if (sortColumn === 'CodigoImt') {
              <i [class]="sortDirection === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down'"></i>
            }
          </th>
          <th (click)="ordenarPor('FechaSolicitud')">
            Fecha Solicitud
            @if (sortColumn === 'FechaSolicitud') {
              <i [class]="sortDirection === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down'"></i>
            }
          </th>
          <th (click)="ordenarPor('FechaPrestamoEsperada')">
            Fecha Esperada
            @if (sortColumn === 'FechaPrestamoEsperada') {
              <i [class]="sortDirection === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down'"></i>
            }
          </th>
          <th (click)="ordenarPor('EstadoPrestamo')">
            Estado
            @if (sortColumn === 'EstadoPrestamo') {
              <i [class]="sortDirection === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down'"></i>
            }
          </th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        @for (prestamo of prestamos; track $index; let i = $index) {
          <tr>
            <td>{{prestamo.Id}}</td>
            <td>{{prestamo.CarnetUsuario || 'N/A'}}</td>
            <td>{{(prestamo.NombreUsuario || '') + ' ' + (prestamo.ApellidoPaternoUsuario || '')}}</td>
            <td>{{prestamo.NombreGrupoEquipo || 'N/A'}}</td>
            <td>{{prestamo.CodigoImt || 'N/A'}}</td>
            <td>{{formatearFecha(prestamo.FechaSolicitud)}}</td>
            <td>{{formatearFecha(prestamo.FechaPrestamoEsperada)}}</td>
            <td>
              <span class="estado-badge" [ngClass]="'estado-' + (prestamo.EstadoPrestamo?.toLowerCase() || 'pendiente')">
                {{prestamo.EstadoPrestamo || 'Pendiente'}}
              </span>
            </td>
            <td class="actions-column">
              <button class="btn-icon btn-delete" (click)="eliminarPrestamo(i)" title="Eliminar">
                <i class="fas fa-trash-alt"></i>
              </button>
              <button class="btn-icon btn-edit" (click)="editarPrestamo(prestamo)" title="Editar">
                <i class="fas fa-pencil-alt"></i>
              </button>
            </td>
          </tr>
        }
        @if (prestamos.length === 0) {
          <tr>
            <td colspan="9" class="empty-table">
              <div class="empty-state">
                <i class="fas fa-search fa-3x"></i>
                <p>No se encontraron préstamos</p>
                <button class="btn btn-outline" (click)="limpiarBusqueda()">Limpiar filtros</button>
              </div>
            </td>
          </tr>
        }
      </tbody>
    </table>
  </div>

  <!-- ALERTA DE ELIMINACIÓN -->
  @if(alertaeliminar) {
    <div class="alerta-eliminar">
      <div class="modal-content">
        <p>¿Estás seguro de que deseas eliminar este préstamo?</p>
        <button class="btn btn-confirm" (click)="confirmarEliminacion()">Sí</button>
        <button class="btn btn-cancel" (click)="cancelarEliminacion()">No</button>
      </div>
    </div>
  }
</div>

@if(botoncrear()) {
  <app-prestamos-crear
    [botoncrear]="botoncrear"
  ></app-prestamos-crear>
}

@if(botoneditar()) {
  <app-prestamos-editar
    [botoneditar]="botoneditar"
    [prestamo]="prestamoSeleccionado"
  ></app-prestamos-editar>
}
